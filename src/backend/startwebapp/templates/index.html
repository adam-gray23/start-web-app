{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
<title>Home Page</title>
<style type="text/css" media="screen">
    body {
        background-color: grey;
    }
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 50%;
    }
    #result {
        position: absolute;
        top: 60%;
        right: 0;
        bottom: 0;
        left: 0;
        width: 50%;
    }
    #getCode {
        position: absolute;
        top: 90%;
    }
    #debugSetting {
        position: absolute;
        top: 80%;
    }
    #step {
        position: absolute;
        top: 85%;
    }
    .breakpoint {
        position: relative;
        top: -12.5px;
        left: -13.5px;
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        margin: 0 auto;
    }
    .ace_gutter-cell.ace_breakpoint{
        border-radius: 20px 0px 0px 20px;
        box-shadow: 0px 0px 1px 1px red inset;
    }

    /* Todo: Move this out of this file */

</style>
</head>
<body>

<div id="editor">write ("hello") nl
write ("hello") nl
write ("hello") nl
</div>

<div>
    <button id="debugSetting">Normal</button>
</div>

<div id="result"></div>

<div>
    {% csrf_token %}
    <button id="getCode">Run Code</button>
</div>

<div>
    {% csrf_token %}
    <button id="step">|></button>
</div>
    
<script src="{% static 'js/ace-src-noconflict/ace.js' %}" type="text/javascript" charset="utf-8"></script>
<script>
    let debugMode = 0;

    let breakpoints = [];

    let paused = false;

    var editor = ace.edit("editor", {
        theme: "ace/theme/tomorrow_night_eighties",
        mode: "ace/mode/start",
        minLines: 30,
        maxLines: 30,
        wrap: false,
        autoScrollEditorIntoView: true
    });

    var result = ace.edit("result", {
        theme: "ace/theme/tomorrow_night_eighties",
        mode: "ace/mode/text",
        minLines: 5,
        maxLines: 15,
        wrap: false,
        autoScrollEditorIntoView: true,
        readOnly: true
    });

    editor.on("guttermousedown", function(e) {
    var target = e.domEvent.target;

    console.log(target.className)

    if (target.className.indexOf("ace_gutter-cell") == -1){
        return;
    }

    if (!editor.isFocused()){
        return; 
    }

    if (e.clientX > 25 + target.getBoundingClientRect().left){
        return;
    }

    var breakpoints = e.editor.session.getBreakpoints(row, 0);
    var row = e.getDocumentPosition().row;

    // If there's a breakpoint already defined, it should be removed, offering the toggle feature
    if(typeof breakpoints[row] === typeof undefined){
        // var bp = document.createElement('div');
        // bp.className = 'breakpoint';

        // var gutter_cell = document.getElementsByClassName('ace_gutter-cell')[row];
        // gutter_cell.appendChild(bp);
        e.editor.session.setBreakpoint(row);
    }else{
        // console.log("here")
        // var gutter_cell = document.getElementsByClassName('ace_gutter-cell')[row];
        // var bp = gutter_cell.getElementsByClassName('breakpoint')[0];
        // gutter_cell.removeChild(bp);
        e.editor.session.clearBreakpoint(row);
    }

    e.stop();
});

    function changeDebugMode() {
        if (debugMode == 2){
            debugMode = 0
        }
        else{
            debugMode++;
        }

        console.log(debugMode)

        var button = document.getElementById("debugSetting");
        if (debugMode == 1){
            button.innerHTML = 'Line-by-Line'
        }
        else if (debugMode == 2){
            button.innerHTML = 'Dynamic'
        }
        else{
            button.innerHTML = 'Normal'
        }
    }

    function stepFunc() {
        var formData = new FormData();
        formData.append("breakpoints", editor.session.getBreakpoints());

        var xhr = new XMLHttpRequest();

        var url = "/step-code/";

        xhr.open("POST", url, true);

        // Set the appropriate headers if needed
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));

        // Define a callback function to handle the response from the server
        xhr.onload = function () {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);

                console.log(response)
            } else {
                console.error("Error sending text content to the server");
            }
        };

        // Send the FormData with the text content to the server
        xhr.send(formData);
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + '=') {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    function uploadCode() {         
        var dummy = document.getElementsByClassName("ace_content")[0].innerText;
        var formData = new FormData();
        formData.append("text_content", dummy);
        formData.append("debugMode", debugMode)
        formData.append("breakpoints", editor.session.getBreakpoints());

        var xhr = new XMLHttpRequest();

        var url = "/upload-code/";

        xhr.open("POST", url, true);

        // Set the appropriate headers if needed
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));

        // Define a callback function to handle the response from the server
        xhr.onload = function () {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);

                if (response.result.error != "") {
                    generateResult(response.result.error);
                }
                else{
                    generateResult(response.result.output);
                }
            } else {
                console.error("Error sending text content to the server");
            }
        };

        // Send the FormData with the text content to the server
        xhr.send(formData);

    };

    function generateResult(text_content){
        result.session.setValue("");

        var resultDiv = document.getElementById("result");
        // chnage result.session length to the length of the output

        result.session.insert({
            row: 0,
            column: 0
        }, text_content);


    }

    editor.onload = function () {
        setTimeout(commFunc, 1000); //Adjust the time required to load
        //setInterval(commFunc, 1000);
    };  

    (function () {
    //Click the button when the page inside the iframe is loaded
    getCode.addEventListener('click', uploadCode);

    debugSetting.addEventListener('click', changeDebugMode)

    step.addEventListener('click', stepFunc)
    })();

    /* Todo: Move this out of this file */

</script>
</body>
</html>